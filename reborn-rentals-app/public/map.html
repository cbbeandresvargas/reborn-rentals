<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Delivery Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: 100%; }
    .map-info {
      position: absolute;
      bottom: 16px;
      left: 16px;
      right: 16px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.15);
      padding: 12px;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Noto Sans, "Apple Color Emoji", "Segoe UI Emoji";
    }
    .map-controls {
      position: absolute;
      top: 16px;
      right: 16px;
      display: grid;
      gap: 8px;
    }
    .btn { background:#CE9704; color:#fff; border:none; padding:8px 10px; border-radius:6px; cursor:pointer; font-weight:600; }
    .btn.secondary { background:#4B5563; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="map-controls">
    <button id="centerOffice" class="btn" title="Center on Reborn Rentals Office">üìç Our Office</button>
    <button id="clearRoute" class="btn secondary" title="Clear Route">üóëÔ∏è Clear Route</button>
  </div>
  <div class="map-info">
    <div style="font-weight:700; color:#1F2937; font-size:14px;">Selected Location</div>
    <div id="info-address" style="color:#374151; font-size:13px; margin-top:4px;">Click on the map to select a delivery location</div>
    <div id="info-distance" style="color:#CE9704; font-size:12px; margin-top:4px;"></div>
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <script>
    // Notificar que el iframe est√° listo
    try { window.parent && window.parent.postMessage({ type: 'map:ready' }, '*'); } catch (e) {}

    const office = { lat: 39.5240405, lng: -119.80605779999999, name: 'Reborn Rentals Office' };
    const map = L.map('map').setView([office.lat, office.lng], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors', maxZoom: 19
    }).addTo(map);

    const officeIcon = L.divIcon({
      html: '<div style="width:40px;height:40px;background:#CE9704;border:3px solid #fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 2px 8px rgba(0,0,0,0.3)">üè¢</div>',
      className: 'custom-div-icon', iconSize: [40, 40], iconAnchor: [20, 20]
    });
    L.marker([office.lat, office.lng], { icon: officeIcon }).addTo(map).bindPopup(office.name);

    let selectedMarker = null;
    let routeLayer = null;
    let lastSelection = null;

    function setInfo(addressText, distanceText) {
      document.getElementById('info-address').textContent = addressText;
      document.getElementById('info-distance').textContent = distanceText || '';
    }

    function calcHaversine(p1, p2) {
      const R = 6371; // km
      const dLat = (p2.lat - p1.lat) * Math.PI / 180;
      const dLng = (p2.lng - p1.lng) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(p1.lat * Math.PI / 180) * Math.cos(p2.lat * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function updateParent(address, destination, extras) {
      try {
        const doc = window.parent && window.parent.document;
        if (!doc) return;
        const selectedAddressEl = doc.getElementById('selected-address');
        const distanceInfoEl = doc.getElementById('distance-info');
        const addressInputEl = doc.getElementById('jobsite-address');
        const locationInfo = doc.getElementById('selected-location-info');
        const addressText = address || (destination ? `Lat: ${destination.lat.toFixed(4)}, Lng: ${destination.lng.toFixed(4)}` : 'Location selected');
        if (selectedAddressEl) selectedAddressEl.textContent = addressText;
        if (addressInputEl) addressInputEl.value = addressText;
        if (distanceInfoEl) {
          if (extras && extras.distanceKm && extras.durationMin != null) {
            distanceInfoEl.textContent = `Distance: ${extras.distanceKm} km ‚Ä¢ Duration: ${extras.durationMin} min`;
          } else if (extras && extras.distanceKm) {
            distanceInfoEl.textContent = `Straight line distance: ${parseFloat(extras.distanceKm).toFixed(1)} km (approximate)`;
          } else {
            distanceInfoEl.textContent = '';
          }
        }
        if (locationInfo) locationInfo.style.display = 'block';
      } catch (e) { /* noop */ }
    }

    function drawRouteAndReport(destination, address) {
      const start = `${office.lng},${office.lat}`;
      const end = `${destination.lng},${destination.lat}`;

      setInfo(address || 'Getting address...', 'Calculating route...');

      fetch(`https://api.openrouteservice.org/v2/directions/driving-car?api_key=5b3ce3597851110001cf6248b4b8b8b8&start=${start}&end=${end}`)
        .then(r => { if (!r.ok) throw new Error(r.status); return r.json(); })
        .then(data => {
          if (routeLayer) { map.removeLayer(routeLayer); routeLayer = null; }
          if (data.features && data.features[0]) {
            const route = data.features[0];
            const distanceKm = (route.properties.summary.distance / 1000).toFixed(1);
            const durationMin = Math.round(route.properties.summary.duration / 60);
            const coordinates = route.geometry.coordinates.map(c => [c[1], c[0]]);
            routeLayer = L.polyline(coordinates, { color:'#CE9704', weight:6, opacity:0.9, dashArray:'10, 5' }).addTo(map);
            map.fitBounds(routeLayer.getBounds().pad(0.1));
            setInfo(address, `Distance: ${distanceKm} km ‚Ä¢ Duration: ${durationMin} min`);

            // Actualizar padre directamente (misma-origin)
            updateParent(address, destination, { distanceKm, durationMin });

            // Notificar al padre
            window.parent && window.parent.postMessage({
              type: 'map:locationSelected',
              lat: destination.lat,
              lng: destination.lng,
              address,
              distanceKm,
              durationMin
            }, '*');
          } else {
            throw new Error('No route');
          }
        })
        .catch(() => {
          // Fallback: l√≠nea recta
          if (routeLayer) { map.removeLayer(routeLayer); routeLayer = null; }
          routeLayer = L.polyline([[office.lat, office.lng],[destination.lat, destination.lng]], { color:'#CE9704', weight:4, opacity:0.6, dashArray:'5, 5' }).addTo(map);
          const distanceKm = calcHaversine(office, destination).toFixed(1);
          setInfo(address, `Straight line distance: ${distanceKm} km (approximate)`);
          updateParent(address, destination, { distanceKm, durationMin: null });
          window.parent && window.parent.postMessage({ type:'map:locationSelected', lat:destination.lat, lng:destination.lng, address, distanceKm, durationMin: null }, '*');
        });
    }

    function handleSelect(lat, lng) {
      if (selectedMarker) { map.removeLayer(selectedMarker); selectedMarker = null; }
      const icon = L.divIcon({
        html: '<div style="width:40px;height:40px;background:#4A4A4A;border:3px solid #fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 2px 8px rgba(0,0,0,0.3)">üìç</div>',
        className: 'custom-div-icon', iconSize:[40,40], iconAnchor:[20,20]
      });
      selectedMarker = L.marker([lat, lng], { icon }).addTo(map).bindPopup('Selected Delivery Location');

      // Reverse geocoding
      setInfo('Getting address...', '');
      fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
        .then(r => r.json())
        .then(data => {
          const address = data.display_name || `Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`;
          lastSelection = { lat, lng, address };
          drawRouteAndReport({ lat, lng }, address);
        })
        .catch(() => {
          const address = `Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`;
          lastSelection = { lat, lng, address };
          drawRouteAndReport({ lat, lng }, address);
        });
    }

    map.on('click', (e) => handleSelect(e.latlng.lat, e.latlng.lng));

    document.getElementById('centerOffice').addEventListener('click', () => {
      map.setView([office.lat, office.lng], 12);
    });
    document.getElementById('clearRoute').addEventListener('click', () => {
      if (routeLayer) { map.removeLayer(routeLayer); routeLayer = null; }
      if (selectedMarker) { map.removeLayer(selectedMarker); selectedMarker = null; }
      setInfo('Click on the map to select a delivery location', '');
      lastSelection = null;
      // Limpiar en el padre
      try {
        const doc = window.parent && window.parent.document;
        if (doc) {
          const selectedAddressEl = doc.getElementById('selected-address');
          const distanceInfoEl = doc.getElementById('distance-info');
          const addressInputEl = doc.getElementById('jobsite-address');
          if (selectedAddressEl) selectedAddressEl.textContent = 'Click on the map to select a delivery location';
          if (distanceInfoEl) distanceInfoEl.textContent = '';
          if (addressInputEl) addressInputEl.value = '';
        }
      } catch (e) { /* noop */ }
      window.parent && window.parent.postMessage({ type:'map:cleared' }, '*');
    });

    // Escuchar mensajes del padre para handshake
    window.addEventListener('message', function(event) {
      const data = event.data || {};
      if (data.type === 'map:parentPing') {
        // Confirmar recepci√≥n
        try { window.parent && window.parent.postMessage({ type: 'map:pong' }, '*'); } catch (e) {}
        // Reenviar √∫ltima selecci√≥n si existe
        if (lastSelection) {
          const { lat, lng, address } = lastSelection;
          window.parent && window.parent.postMessage({ type:'map:locationSelected', lat, lng, address }, '*');
        }
      }
    });
  </script>
</body>
</html>


